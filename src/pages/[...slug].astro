---
import BaseLayout from "../layouts/BaseLayout.astro";
import ComicPanel from "../components/ComicPanel.astro";
import { db, Stories, Panels, eq, and } from "astro:db";

export async function getStaticPaths() {
    const stories = await db.select().from(Stories);
    const panels = await db.select().from(Panels);

    const paths: any[] = [];

    // Paths for story root (redirects or shows first panel)
    stories.forEach((story) => {
        paths.push({ params: { slug: story.slug } });
    });

    // Paths for specific panels e.g., /pauls/1, /pauls/2
    panels.forEach((panel) => {
        paths.push({ params: { slug: `${panel.storySlug}/${panel.order}` } });
    });

    return paths;
}

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect("/404");
}

const parts = slug.split("/");
const storySlug = parts[0];
let panelOrder = parts.length > 1 ? Number(parts[1]) : 1;

const stories = await db
    .select()
    .from(Stories)
    .where(eq(Stories.slug, storySlug));
const story = stories[0];

if (!story) {
    return Astro.redirect("/404");
}

const panels = await db
    .select()
    .from(Panels)
    .where(and(eq(Panels.storySlug, storySlug), eq(Panels.order, panelOrder)));
const panel = panels[0];

if (!panel) {
    // If specific panel path doesn't exist, go to first panel
    return Astro.redirect(`/${storySlug}/1`);
}

// Check for next panel
const nextPanels = await db
    .select()
    .from(Panels)
    .where(
        and(eq(Panels.storySlug, storySlug), eq(Panels.order, panelOrder + 1)),
    );
const hasNextPanel = nextPanels.length > 0;
const nextUrl = hasNextPanel ? `/${storySlug}/${panelOrder + 1}` : "/";
const buttonText = hasNextPanel ? "Continue Story" : "Complete Mission";

// Check for prev panel
const hasPrevPanel = panelOrder > 1;
const prevUrl = hasPrevPanel ? `/${storySlug}/${panelOrder - 1}` : null;
---

<BaseLayout title={story.title} hideHeader={true}>
    <article class="w-full h-screen bg-slate-900 overflow-hidden">
        <div
            id="layout-container"
            class="grid grid-cols-1 lg:flex h-full overflow-hidden"
        >
            <!-- Left Side: Comic Panel -->
            <div
                id="comic-container"
                class="flex-grow h-full flex items-center justify-center bg-slate-950/20 px-4 relative overflow-hidden"
            >
                {panel.imageUrl && <ComicPanel imageUrl={panel.imageUrl} />}

                <!-- Resize Handle for Desktop -->
                <div
                    id="resize-handle"
                    class="hidden lg:flex absolute bottom-8 right-8 z-40 cursor-ew-resize group pointer-events-auto"
                >
                    <div
                        class="w-14 h-14 bg-yellow-500 rounded-2xl flex flex-col items-center justify-center shadow-[0_0_30px_rgba(234,179,8,0.4)] border-4 border-slate-900 transform group-hover:scale-110 group-hover:rotate-3 active:scale-95 active:rotate-0 transition-all duration-300"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="w-7 h-7 text-slate-950"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="3"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <path d="M18 8L22 12L18 16"></path>
                            <path d="M6 8L2 12L6 16"></path>
                            <circle cx="12" cy="12" r="1" fill="currentColor"
                            ></circle>
                        </svg>
                        <span
                            class="text-[8px] font-black text-slate-950 mt-0.5 uppercase tracking-tighter"
                            >Resize</span
                        >
                    </div>
                    <!-- Tooltip -->
                    <div
                        class="absolute bottom-full right-0 mb-4 px-4 py-2 bg-slate-900 text-yellow-500 text-xs font-black rounded-lg opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0 whitespace-nowrap border-2 border-yellow-500 shadow-xl pointer-events-none"
                    >
                        DRAG TO ADJUST OR CLICK TO CYCLE
                    </div>
                </div>
            </div>

            <!-- Divider Line -->
            <div
                id="resizer-bar"
                class="hidden lg:block w-1 bg-slate-800 border-x border-slate-950/50"
            >
            </div>

            <!-- Right Side: Sidebar -->
            <div
                id="sidebar"
                class="w-full lg:w-[25%] flex flex-col h-full bg-slate-900 shadow-2xl relative z-10 min-w-[320px] max-w-[80vw] transition-[width] duration-75 ease-out"
            >
                <div
                    class="flex-grow overflow-y-auto p-10 lg:p-14 space-y-12 custom-scrollbar"
                >
                    <header class="text-left space-y-4">
                        <h1
                            class="text-3xl md:text-4xl lg:text-5xl font-black text-white uppercase whitespace-nowrap leading-tight drop-shadow-[0_0_20px_rgba(255,255,255,0.1)]"
                            style="font-family: 'Bangers', cursive;"
                        >
                            {story.title}
                        </h1>
                        <div
                            class="h-1.5 bg-gradient-to-r from-yellow-500 via-orange-500 to-transparent w-full rounded-full opacity-90"
                        >
                        </div>
                    </header>

                    <div
                        id="story-intro"
                        class="prose prose-invert prose-xl opacity-60 italic font-serif leading-relaxed"
                    >
                        <Fragment set:html={panel.fullStory} />
                    </div>

                    <div
                        id="story-bubbles"
                        class="flex flex-col gap-6 max-w-none pb-12"
                        data-captions={JSON.stringify(
                            panel.typedCaptions || [],
                        )}
                    >
                    </div>
                </div>

                <!-- Anchored Footer -->
                <div
                    id="story-footer"
                    class="p-6 lg:p-10 bg-slate-900/80 backdrop-blur-xl border-t border-slate-800 space-y-4 opacity-0 transition-all duration-700 translate-y-4"
                >
                    {
                        hasPrevPanel && (
                            <div class="text-center mb-2">
                                <a
                                    href={prevUrl}
                                    class="text-slate-500 hover:text-yellow-500 text-xs font-bold uppercase tracking-[0.2em] transition-colors duration-200"
                                >
                                    &larr; BACK
                                </a>
                            </div>
                        )
                    }
                    <a
                        id="continue-button"
                        href={nextUrl}
                        class="block w-full py-5 bg-yellow-500 hover:bg-yellow-400 text-slate-950 text-3xl font-black text-center rounded-2xl shadow-[0_0_50px_rgba(234,179,8,0.2)] transition-all duration-300 transform hover:-translate-y-1 hover:scale-[1.01] active:translate-y-0 uppercase pointer-events-none"
                        style="font-family: 'Bangers', cursive;"
                    >
                        {buttonText}
                    </a>

                    <div class="text-center">
                        <a
                            href="/"
                            class="inline-block text-slate-500 hover:text-yellow-500 text-xs font-bold uppercase tracking-[0.2em] transition-colors duration-200"
                        >
                            &larr; MISSION CONTROL
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </article>
</BaseLayout>

<script>
    const observeOptions = {
        threshold: 0.1,
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                const element = entry.target as HTMLElement;
                element.classList.remove("opacity-0", "translate-y-4");
                element.classList.add("opacity-100", "translate-y-0");
            }
        });
    }, observeOptions);

    const observeCaptions = () => {
        document.querySelectorAll(".caption-text").forEach((caption) => {
            observer.observe(caption);
        });
    };

    // Story Text Sequencer
    let textTimeouts: number[] = [];
    const initStorySequencer = () => {
        const bubbleContainer = document.getElementById("story-bubbles");
        const introContainer = document.getElementById("story-intro");
        const footer = document.getElementById("story-footer");
        const button = document.getElementById("continue-button");

        if (
            !bubbleContainer ||
            !innerSidebar() ||
            !footer ||
            !button ||
            !introContainer
        )
            return;

        // Cleanup
        textTimeouts.forEach(clearTimeout);
        textTimeouts = [];

        // Reset
        footer.classList.add("opacity-0", "translate-y-4");
        button.classList.add("pointer-events-none");
        bubbleContainer.innerHTML = "";

        // Get full text from intro container and explicit captions
        const fullContent = introContainer.textContent || "";
        let explicitCaptions: string[] = [];
        try {
            const raw = bubbleContainer.getAttribute("data-captions");
            explicitCaptions = raw ? JSON.parse(raw) : [];
        } catch (e) {}

        // Intelligent sentence splitting
        const allSentences = fullContent
            .split(/(?<=[.!?])\s+/)
            .filter((s) => s.trim().length > 0);

        // Per user request: Title -> Brief Sentence -> Action Narrative (Bubbles)
        // We take the first sentence as the "intro" and everything else as bubbles
        const introText = allSentences.shift() || "";
        const actionSentences = [...allSentences, ...explicitCaptions];

        // Update Intro
        introContainer.innerHTML = `<p>${introText}</p>`;

        const bubbleElements: HTMLElement[] = [];
        actionSentences.forEach((sentence) => {
            const bubble = document.createElement("div");
            bubble.className = "comic-caption";
            bubble.textContent = sentence;

            const rotation = (Math.random() * 4 - 2).toFixed(2);
            bubble.style.setProperty("--rotation", `${rotation}deg`);

            bubbleContainer.appendChild(bubble);
            bubbleElements.push(bubble);
        });

        const showFinish = () => {
            bubbleElements.forEach((b) => b.classList.add("popped"));
            footer.classList.remove("opacity-0", "translate-y-4");
            footer.classList.add("opacity-100", "translate-y-0");
            button.classList.remove("pointer-events-none");
        };

        if (bubbleElements.length === 0) {
            showFinish();
            return;
        }

        let totalDelay = 800; // Small delay after intro
        bubbleElements.forEach((bubble, index) => {
            const timeout = setTimeout(() => {
                bubble.classList.add("popped");
                if (index === bubbleElements.length - 1) {
                    const finishTimeout = setTimeout(
                        showFinish,
                        600,
                    ) as unknown as number;
                    textTimeouts.push(finishTimeout);
                }
            }, totalDelay) as unknown as number;
            textTimeouts.push(timeout);
            totalDelay += 1800;
        });

        const sidebarElement = document.getElementById("sidebar");
        const onSkip = (e: MouseEvent) => {
            if ((e.target as HTMLElement).closest("#continue-button")) return;
            textTimeouts.forEach(clearTimeout);
            showFinish();
            sidebarElement?.removeEventListener("click", onSkip);
        };
        sidebarElement?.addEventListener("click", onSkip);
    };

    function innerSidebar() {
        return document.getElementById("sidebar");
    }

    // Panel Resizing Logic
    const initResizer = () => {
        const handle = document.getElementById("resize-handle");
        const sidebar = document.getElementById("sidebar");
        const container = document.getElementById("layout-container");

        if (!handle || !sidebar || !container) return;

        let isResizing = false;
        let startX = 0;
        let startWidth = 0;
        let hasMoved = false;

        // Load saved width
        const savedWidth = localStorage.getItem("sidebar-width");
        if (savedWidth && window.innerWidth >= 1024) {
            sidebar.style.width = savedWidth;
        }

        const onMouseMove = (e: MouseEvent) => {
            if (!isResizing) return;

            const deltaX = startX - e.clientX;
            const newWidth = startWidth + deltaX;

            if (Math.abs(deltaX) > 5) hasMoved = true;

            const containerWidth = container.offsetWidth;
            const minWidth = 320;
            const maxWidth = containerWidth * 0.8;

            if (newWidth >= minWidth && newWidth <= maxWidth) {
                const widthPercent = (newWidth / containerWidth) * 100;
                sidebar.style.width = `${widthPercent}%`;
            }
        };

        const onMouseUp = () => {
            if (!isResizing) return;

            isResizing = false;
            document.body.style.cursor = "default";
            document.body.style.userSelect = "auto";
            sidebar.classList.add("transition-[width]");

            localStorage.setItem("sidebar-width", sidebar.style.width);

            window.removeEventListener("mousemove", onMouseMove);
            window.removeEventListener("mouseup", onMouseUp);
        };

        const onMouseDown = (e: MouseEvent) => {
            isResizing = true;
            startX = e.clientX;
            startWidth = sidebar.offsetWidth;
            hasMoved = false;

            document.body.style.cursor = "ew-resize";
            document.body.style.userSelect = "none";
            sidebar.classList.remove("transition-[width]");

            window.addEventListener("mousemove", onMouseMove);
            window.addEventListener("mouseup", onMouseUp);
        };

        const onClick = (e: MouseEvent) => {
            if (hasMoved) return;
            // Don't cycle if clicking on story text to skip animation
            if ((e.target as HTMLElement).closest(".prose")) return;

            const currentWidth = parseFloat(sidebar.style.width) || 25;
            let nextWidth = 25;

            if (currentWidth < 30) nextWidth = 40;
            else if (currentWidth < 50) nextWidth = 60;
            else nextWidth = 25;

            sidebar.style.width = `${nextWidth}%`;
            localStorage.setItem("sidebar-width", `${nextWidth}%`);
        };

        handle.addEventListener("mousedown", onMouseDown);
        handle.addEventListener("click", onClick);
    };

    // Initial observation
    observeCaptions();
    initResizer();
    initStorySequencer();

    // Re-observe if needed (e.g. after nav)
    document.addEventListener("astro:after-swap", () => {
        observeCaptions();
        initResizer();
        initStorySequencer();
    });
</script>

<style>
    :global(main) {
        max-width: none !important;
        padding: 0 !important;
    }

    :global(.comic-caption) {
        background: #fde047 !important; /* yellow-300 */
        color: #020617 !important; /* slate-950 */
        padding: 1.25rem 1.75rem !important;
        border: 4px solid #020617 !important;
        box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.4) !important;
        position: relative !important;
        font-family: "Bangers", cursive !important;
        font-size: 2rem !important;
        line-height: 1.1 !important;
        transform: scale(0) !important;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
        z-index: 20 !important;
        display: block !important;
        margin-bottom: 1.5rem !important;
        width: fit-content !important;
        max-width: 100% !important;
    }

    :global(.comic-caption.popped) {
        transform: scale(1) rotate(var(--rotation)) !important;
    }

    :global(.comic-caption::before) {
        content: "";
        position: absolute;
        top: -4px;
        left: -4px;
        right: -4px;
        bottom: -4px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        pointer-events: none;
    }

    :global(.story-sentence) {
        display: block;
        margin-bottom: 1.5rem;
    }
</style>
